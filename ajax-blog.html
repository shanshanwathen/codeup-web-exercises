<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <title>Ajax Blog</title>

    <style>
        body {
            font-family: 'Noto Sans HK', sans-serif;
        }
    </style>
</head>
<body>
<h1 class="text-center">Ajax Blog</h1>

<div id="posts"></div>

<form class="m-3">
    <div class="form-group">
        <label for="title">Title</label>
        <input type="text" class="form-control" id="title">
    </div>
    <div class="form-group">
        <label for="categories">Categories</label>
        <input type="text" class="form-control" id="categories">
    </div>
    <div class="form-group">
        <label for="content">Content</label>
        <textarea class="form-control" id="content" rows="5"></textarea>
    </div>
    <button type="button" class="btn btn-info" id="addPost">Add post</button>
    <button type="button" class="btn btn-info" id="deletePost">Delete post</button>
</form>



<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

<script>
    function renderPost (post)  {
        var contents = "";
        contents += '<div class="card m-3"><div class="card-body p-0">';
        contents += '<h5 class="card-title bg-info text-white p-3 m-0 rounded-top">' + post.title + '</h5>';
        contents += '<p class="card-text m-1 ml-3"><small class="font-italic">' + post.categories + "</small></p>";
        contents += '<p class="card-text m-3">' + post.content + "</p>";
        contents += '<p class="card-text text-right pr-3"><small class="text-muted">' + post.date + '</small></p>';
        contents += '</div></div>';
        $("#posts").append(contents);
    }

    var newPost = {};
    var postsRequest = $.ajax("data/blog.json");

    function addPosts () {
        postsRequest.done(function (data) {
            data.data.forEach(renderPost);
        });

        postsRequest.fail(function () {
            $("#posts").html("Oops, something went wrong :(");
        });
    }

    addPosts();

    $(document).ready(function () {
        $("#title").keyup(function () {
            newPost.title = $(this).val();
        });
        $("#categories").keyup(function () {
            newPost.categories = $(this).val();
        });
        $("#content").keyup(function () {
            newPost.content = $(this).val();
        });

        $("#addPost").click(function(e) {
            e.preventDefault();
            var date = new Date().toString().split(" ");
            var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            months.forEach(function (month) {
                if (month.includes(date[1])) {
                    newPost.date = month + " " + date[2] + ", " + date[3];
                }
            });

            $('form').trigger("reset");

            var addToJson = $.ajax("http://localhost:3000/data", {
                method: "POST",
                data: newPost
            });

            addToJson.done(function (data) {
                $("#posts").html("");
                addPosts();
            });
        });

        $("#deletePost").click(function (e) {
            e.preventDefault();
            postsRequest.done(function (data) {
                var blogPosts = data.data;
                var postsToDelete = [];
                blogPosts.forEach(function (blogPost) {
                    if (blogPost.id !== 1 && blogPost.id !== 2) {
                        postsToDelete.push(blogPost);
                    }
                });

                console.log(postsToDelete[0]);

                var removeFromJson = $.ajax("http://localhost:3000/data", {
                    method: "DELETE",

                    data: postsToDelete[0]
                });

                removeFromJson.done(function (data) {
                    $("#posts").html("");
                    addPosts();
                });
            });
        });
    });

</script>

</body>
</html>