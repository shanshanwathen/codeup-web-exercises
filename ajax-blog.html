<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <title>Ajax Blog</title>

    <style>
        body {
            font-family: 'Noto Sans HK', sans-serif;
        }
    </style>
</head>
<body>
<h1 class="text-center">Ajax Blog</h1>

<div id="posts"></div>

<form class="m-3">
    <div class="form-group">
        <label for="title">Title</label>
        <input type="text" class="form-control" id="title">
    </div>
    <div class="form-group">
        <label for="categories">Categories</label>
        <input type="text" class="form-control" id="categories">
    </div>
    <div class="form-group">
        <label for="content">Content</label>
        <textarea class="form-control" id="content" rows="5"></textarea>
    </div>
    <button type="button" class="btn btn-info" id="addPost">Add post</button>
    <button type="button" class="btn btn-info" id="deletePost">Delete post</button>
</form>



<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

<script>
    function renderPost (post)  {
        let contents =
            `<div class="card m-3">
                <div class="card-body p-0">
                <h5 class="card-title bg-info text-white p-3 m-0 rounded-top">${post.title}</h5>
                <p class="card-text m-1 ml-3"><small class="font-italic">${post.categories}</small></p>
                <p class="card-text m-3">${post.content}</p>
                <p class="card-text text-right pr-3"><small class="text-muted">${post.date}</small></p>
                </div>
            </div>`;

        $("#posts").append(contents);
    }

    function displayPosts () {
        fetch("data/blog.json")
            .then(data => {return data.json()})
            .then(postsObj => {
                postsObj.posts.forEach(post => renderPost(post))
            })
            .catch(() => {
            $("#posts").html("Oops, something went wrong :(");
        });
    }

    displayPosts();

    $(document).ready(() => {
        // get newPost title, categories and content
        let newPost = {};
        $("#title").keyup((e) => newPost.title = $(e.target).val());
        $("#categories").keyup((e) => {
            newPost["categories"] = $(e.target).val().split(", ");;
            console.log(newPost.categories);

            console.log(newPost);

        });

        $("#content").keyup((e) => newPost.content = $(e.target).val());

        $("#addPost").click((e) => {
            e.preventDefault();

            let date = new Date().toString().split(" ");
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            months.forEach((month) => {
                if (month.includes(date[1])) {
                    newPost.date = `${month} ${date[2]}, ${date[3]}`;
                }
            });

            console.log(newPost);

            let addToJson = $.ajax("http://localhost:3000/posts", {
                method: "POST",
                data: {
                    title: $("#title".val()),

                }
            });

            console.log(addToJson);

            addToJson.done(function (data) {
                console.log(data);
                $("#posts").html("");
                displayPosts();
            });

            $('form').trigger("reset");

            // const options = {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json',
            //     },
            //     body: JSON.stringify(newPost),
            // };
            //
            // fetch("http://localhost:3000/posts", options)
            //     .then(response => {return response.json()})
            //     .then(results => {
            //         displayPosts(results);
            //     })
            //     .catch(() => $("#posts").html("Oops, something went wrong :("));

            //     .then(response => fetch("/blog.json").then(response => (response.json())).then(response => displayPosts(response)))
            //     .catch()
        });
    });

</script>

</body>
</html>